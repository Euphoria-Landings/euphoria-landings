name: Deploy All Euphoria Lands

on:
  push:
    branches: ["main", "master"]

jobs:
  deploy:
    runs-on: [self-hosted, Linux, X64]

    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: ğŸš€ Tozalash va Qayta O'rnatish
        run: |
          # 1. Manzillarni belgilaymiz
          PARENT_DIR="/media/user/disc"
          TARGET_DIR="$PARENT_DIR/euphoria-landings"
          REPO_URL="https://github.com/Euphoria-Landings/euphoria-landings.git"

          # 2. Eski konteynerlarni to'xtatish
          echo "ğŸ›‘ Eski konteynerlarni to'xtatish..."
          docker ps -a --format '{{.Names}}' | grep euphoria-lands | xargs -r docker stop
          docker ps -a --format '{{.Names}}' | grep euphoria-lands | xargs -r docker rm

          # 3. Papkani tozalash
          echo "ğŸ—‘ï¸ Eski papkani o'chirish..."
          rm -rf $PARENT_DIR/euphoria-lands
          rm -rf $TARGET_DIR

          # 4. Yangi Super-Repo-ni clone qilish
          cd $PARENT_DIR
          git clone $REPO_URL
          cd $TARGET_DIR

          # 5. Docker build (Barqaror usul)
          # --parallel=1 server RAM va Diskiga og'irlik tushirmaslik uchun bittadan build qiladi
          echo "ğŸ—ï¸ Docker konteynerlar bittadan build qilinmoqda..."
          docker compose -p euphoria-lands build --parallel=1

          echo "ğŸš€ Konteynerlarni ishga tushirish..."
          docker compose -p euphoria-lands up -d

          # 6. Tozalash
          echo "ğŸ§¹ Eski keraksiz qatlamlarni tozalash..."
          docker image prune -af

      - name: âœ… Holatni tekshirish
        run: |
          sleep 5
          docker ps | grep euphoria-lands
