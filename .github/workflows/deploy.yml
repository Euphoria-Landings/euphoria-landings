name: Deploy All Euphoria Lands

on:
  push:
    branches: ["main", "master"]

jobs:
  deploy:
    runs-on: [self-hosted, Linux, X64]

    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: üöÄ Tozalash va Qayta O'rnatish
        run: |
          # 1. Manzillarni belgilaymiz
          # SIZDA ESKI PAPKA NOMI 'euphoria-lands' EDI, YANGI REPO NOMI ESA 'euphoria-landings'
          PARENT_DIR="/media/user/disc"
          TARGET_DIR="$PARENT_DIR/euphoria-landings"
          REPO_URL="https://github.com/Euphoria-Landings/euphoria-landings.git"

          # 2. Eski konteynerlarni to'xtatish (agar bo'lsa)
          # 'euphoria-lands' nomli barcha konteynerlarni o'chiradi
          docker ps -a --format '{{.Names}}' | grep euphoria-lands | xargs -r docker stop
          docker ps -a --format '{{.Names}}' | grep euphoria-lands | xargs -r docker rm

          # 3. Agar eski papka bo'lsa, uni butunlay o'chiramiz (Noldan boshlash uchun)
          # DIQQAT: Agar papka nomi 'euphoria-lands' bo'lsa shuni o'chiramiz
          rm -rf $PARENT_DIR/euphoria-lands
          rm -rf $TARGET_DIR

          # 4. Yangi Super-Repo-ni clone qilamiz
          cd $PARENT_DIR
          git clone $REPO_URL

          # 5. Loyiha papkasiga kirib, Docker-ni ishga tushiramiz
          cd $TARGET_DIR

          echo "üèóÔ∏è Docker konteynerlar build qilinmoqda..."
          docker compose -p euphoria-lands up -d --build

          # 6. Tozalash (eski buildlar diskni to'ldirmasligi uchun)
          echo "üßπ Eski keraksiz image-larni tozalash..."
          docker image prune -af

      - name: ‚úÖ Holatni tekshirish
        run: docker ps | grep euphoria-lands
