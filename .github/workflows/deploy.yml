name: Deploy Euphoria Landings

on:
  push:
    branches: ["main", "master"]

jobs:
  deploy:
    name: ğŸš€ Production Deploy
    runs-on: [self-hosted, Linux, X64]
    
    # Bir vaqtda ikkita deploy bo'lib ketmasligi uchun
    concurrency:
      group: production
      cancel-in-progress: true

    steps:
      - name: ğŸ“¥ Source kodni yuklash
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Muhitni tayyorlash va Tozalash
        run: |
          # Professional yo'l: loyihani /opt yoki /home ichida saqlash
          TARGET_DIR="/home/deploy/euphoria-landings"
          
          echo "ğŸ§¹ Eski kesh va keraksiz elementlarni tozalash..."
          docker image prune -f
          
          if [ -d "$TARGET_DIR" ]; then
            cd $TARGET_DIR
            git pull origin main
          else
            git clone ${{ github.server_url }}/${{ github.repository }}.git $TARGET_DIR
            cd $TARGET_DIR
          fi

      - name: ğŸ—ï¸ Ketma-ket Build va Deploy (Sequential)
        run: |
          cd /home/deploy/euphoria-landings
          
          # Docker Compose faylidagi barcha servislarni ro'yxatga olish
          SERVICES=$(docker compose config --services)
          
          echo "ğŸš€ Loyihalarni bittalab ishga tushirish..."
          for service in $SERVICES; do
            echo "--------------------------------------------"
            echo "ğŸ“¦ Building & Starting: $service"
            
            # --build: yangi o'zgarishni yig'adi
            # -d: fonda ishga tushiradi
            # --remove-orphans: keraksiz konteynerlarni o'chiradi
            docker compose -p euphoria-lands up -d --build --remove-orphans $service
            
            echo "âœ… $service muvaffaqiyatli ishga tushdi."
            
            # CPU dam olishi uchun kichik tanaffus
            sleep 2
          done

      - name: ğŸ§¹ Post-Deploy tozalash
        if: always()
        run: |
          echo "ğŸ—‘ï¸ Foydalanilmayotgan danggler (osilib qolgan) imagelarni o'chirish..."
          docker image prune -af

      - name: âœ… Salomatlikni tekshirish (Health Check)
        run: |
          echo "ğŸ“Š Ishlayotgan konteynerlar holati:"
          docker ps --filter "name=euphoria-lands" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"