name: Deploy Euphoria Landings

on:
  push:
    branches: ["main", "master"]

jobs:
  deploy:
    name: üöÄ Production Deploy
    runs-on: [self-hosted, Linux, X64]
    concurrency:
      group: production
      cancel-in-progress: true

    steps:
      - name: üì• Source kodni yuklash
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Muhitni tayyorlash
        run: |
          TARGET_DIR="/home/deploy/euphoria-landings"
          if [ -d "$TARGET_DIR" ]; then
            cd $TARGET_DIR
            git fetch --all
            git reset --hard origin/$(git branch --show-current)
          else
            git clone ${{ github.server_url }}/${{ github.repository }}.git $TARGET_DIR
            cd $TARGET_DIR
          fi

      - name: üèóÔ∏è Brute-Force Deploy (Barcha portlarni ochish)
        run: |
          cd /home/deploy/euphoria-landings

          # 1. Eng muhim qadam: Docker-dagi barcha konteynerlarni to'xtatib, tarmoqni bo'shatish
          echo "üß® Docker konteynerlarini majburiy to'xtatish..."
          docker compose down --remove-orphans || true

          # 2. Portlarni OS darajasida "qonatib" o'ldirish
          echo "üíÄ Portlarni (3001-3015, 8080) majburiy bo'shatish..."
          sudo fuser -k 3001/tcp 3002/tcp 3003/tcp 3004/tcp 3005/tcp 3006/tcp 3007/tcp 3008/tcp 3009/tcp 3010/tcp 3011/tcp 3012/tcp 3013/tcp 3014/tcp 3015/tcp 8080/tcp || true

          # 3. Docker-ning o'lik tarmoqlarini tozalash
          docker network prune -f || true

          # 4. Endi bittadan build qilib, ishga tushirish
          SERVICES=$(docker compose config --services)
          for service in $SERVICES; do
            echo "--------------------------------------------"
            echo "üì¶ Deploying: $service"
            
            # Har bir servis oldidan yana bir bor portni tekshirish
            sudo fuser -k 3001-3015/tcp 8080/tcp || true
            
            docker compose up -d --build --force-recreate $service
            
            echo "‚úÖ $service ishga tushdi."
            sleep 2 # Kernel portni to'liq bog'lashi uchun vaqt
          done

      - name: üßπ Post-Deploy tozalash
        if: always()
        run: |
          docker image prune -f

      - name: ‚úÖ Final Tekshiruv
        run: |
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
