name: Deploy All Euphoria Lands

on:
  push:
    branches: ["main", "master"]

jobs:
  deploy:
    runs-on: [self-hosted, Linux, X64]

    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: ğŸš€ Tozalash va Qayta O'rnatish
        run: |
          PARENT_DIR="/media/user/disc"
          TARGET_DIR="$PARENT_DIR/euphoria-landings"
          REPO_URL="https://github.com/Euphoria-Landings/euphoria-landings.git"

          echo "ğŸ›‘ Eski konteynerlarni o'chirish..."
          docker ps -a --format '{{.Names}}' | grep euphoria-lands | xargs -r docker stop
          docker ps -a --format '{{.Names}}' | grep euphoria-lands | xargs -r docker rm

          echo "ğŸ—‘ï¸ Papkalarni yangilash..."
          rm -rf $PARENT_DIR/euphoria-lands
          rm -rf $TARGET_DIR

          cd $PARENT_DIR
          git clone $REPO_URL
          cd $TARGET_DIR

          echo "ğŸ—ï¸ Bittadan build qilish (RAM tejash)..."
          docker compose -p euphoria-lands build --parallel=1

          echo "ğŸš€ Konteynerlarni ishga tushirish..."
          docker compose -p euphoria-lands up -d

          echo "ğŸ§¹ Tozalash..."
          docker image prune -af

      - name: âœ… Holatni tekshirish
        run: |
          sleep 5
          docker ps | grep euphoria-lands
