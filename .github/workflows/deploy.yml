name: Deploy Euphoria Landings (Optimized)

on:
  push:
    branches: ["main", "master"]

jobs:
  deploy:
    name: ğŸš€ Production Deploy
    runs-on: [self-hosted, Linux, X64]
    
    concurrency:
      group: production
      cancel-in-progress: true

    steps:
      - name: ğŸ“¥ Source kodni yuklash
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Deploy jarayoni
        run: |
          TARGET_DIR="/home/deploy/euphoria-landings"
          
          if [ -d "$TARGET_DIR" ]; then
            cd $TARGET_DIR
            git pull origin main
          else
            git clone ${{ github.server_url }}/${{ github.repository }}.git $TARGET_DIR
            cd $TARGET_DIR
          fi
          
          echo "ğŸš€ Nginx Image'ni yangilash va konteynerlarni qayta yoqish..."
          # Build shart emas, faqat pull va up
          docker compose -p euphoria-lands pull
          docker compose -p euphoria-lands up -d --remove-orphans

      - name: ğŸ§¹ Serverni tozalash
        run: |
          echo "ğŸ—‘ï¸ Eski va foydalanilmayotgan Docker resurslarini tozalash..."
          docker system prune -f

      - name: âœ… Holatni tekshirish
        run: |
          docker ps --filter "name=euphoria-lands" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"