name: Deploy Euphoria Landings

on:
  push:
    branches: ["main", "master"]

jobs:
  deploy:
    name: üöÄ Production Deploy
    runs-on: [self-hosted, Linux, X64]

    concurrency:
      group: production
      cancel-in-progress: true

    steps:
      - name: üì• Source kodni yuklash
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Muhitni tayyorlash
        run: |
          TARGET_DIR="/home/deploy/euphoria-landings"
          echo "üßπ Docker tizimini tozalash..."
          docker image prune -f

          if [ -d "$TARGET_DIR" ]; then
            cd $TARGET_DIR
            git fetch --all
            git reset --hard origin/main
          else
            git clone ${{ github.server_url }}/${{ github.repository }}.git $TARGET_DIR
          fi

      - name: üèóÔ∏è Agresiv Port Tozalash va Deploy
        run: |
          cd /home/deploy/euphoria-landings

          # Barcha servislarni olish
          SERVICES=$(docker compose config --services)

          for service in $SERVICES; do
            echo "--------------------------------------------"
            # Docker Compose faylidan portni aniqlash (masalan 8080 yoki 3001)
            PORT=$(docker compose config | grep -A 5 "$service:" | grep "ports:" -A 1 | grep -oE '[0-9]+' | head -n 1)
            
            if [ ! -z "$PORT" ]; then
              echo "üõ°Ô∏è Port $PORT ni majburan tozalash ($service uchun)..."
              sudo fuser -k $PORT/tcp || true
            fi

            echo "üì¶ Building & Starting: $service"
            # --force-recreate: port bog'lanishini yangilash uchun shart
            docker compose -p euphoria-lands up -d --build --remove-orphans --force-recreate $service
            
            echo "‚úÖ $service muvaffaqiyatli ishga tushdi."
            sleep 1
          done

      - name: ‚úÖ Yakuniy tekshiruv
        run: |
          docker ps --filter "name=euphoria-lands" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
