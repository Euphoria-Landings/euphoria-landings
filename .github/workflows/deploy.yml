name: Deploy Euphoria Landings

on:
  push:
    branches: ["main", "master"]

jobs:
  deploy:
    name: üöÄ Production Deploy
    runs-on: [self-hosted, Linux, X64]
    concurrency:
      group: production
      cancel-in-progress: true

    steps:
      - name: üì• Source kodni yuklash
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Muhitni tayyorlash va Tozalash
        run: |
          TARGET_DIR="/home/deploy/euphoria-landings"
          echo "üßπ Docker tizimini tozalash..."
          docker image prune -f
          
          if [ -d "$TARGET_DIR" ]; then
            cd $TARGET_DIR
            git fetch --all
            git reset --hard origin/$(git branch --show-current)
          else
            git clone ${{ github.server_url }}/${{ github.repository }}.git $TARGET_DIR
            cd $TARGET_DIR
          fi

      - name: üèóÔ∏è Majburiy (Force) Port Tozalash va Deploy
        run: |
          cd /home/deploy/euphoria-landings
          
          # 1. Barcha ehtimoliy portlarni (3001-3015 va 8080) bittada tozalash
          echo "üß® Portlarni majburiy bo'shatish..."
          sudo fuser -k 3001/tcp 3002/tcp 3003/tcp 3004/tcp 3005/tcp 3006/tcp 3007/tcp 3008/tcp 3009/tcp 3010/tcp 3011/tcp 3012/tcp 3013/tcp 3014/tcp 3015/tcp 8080/tcp || true
          
          # 2. Docker Compose xizmatlarini olish
          SERVICES=$(docker compose config --services)
          
          for service in $SERVICES; do
            echo "--------------------------------------------"
            echo "üì¶ Processing: $service"
            
            # Har bir servis uchun konteynerni o'chirib, keyin yoqish (Port xatosi bermasligi uchun eng xavfsiz yo'l)
            docker compose stop $service || true
            docker compose rm -f $service || true
            
            # Build va Up
            docker compose up -d --build --remove-orphans $service
            
            echo "‚úÖ $service qayta ishga tushdi."
            sleep 1
          done

      - name: üßπ Post-Deploy tozalash
        if: always()
        run: |
          docker image prune -af

      - name: ‚úÖ Salomatlikni tekshirish (Health Check)
        run: |
          echo "üìä Final Konteynerlar holati:"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"